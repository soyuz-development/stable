# Use ubuntu's rolling tag as the base image
FROM ubuntu:rolling AS base


FROM base AS plymouth-builder

#install deps related to plymouth
RUN apt-get update && apt-get install --no-install-recommends -y meson git ca-certificates

WORKDIR /branding

RUN mkdir -p src_dir target_dir

WORKDIR /branding/src_dir

RUN git clone --single-branch -b main https://github.com/saturn-core/plymouth-theme.git && \
    cd plymouth-theme && \
    meson setup builddir && \
    meson install -C builddir


FROM base AS interim-layer

COPY overrides /usr/share/glib-2.0/schemas/99_saturn.gschema.override

RUN apt-get update -y && apt-get --no-install-recommends install -y initramfs-tools init sudo perl && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}

#configure plymouth and hosts
COPY --from=plymouth-builder /usr/share/plymouth/themes/saturn-bgrt/* /usr/share/plymouth/themes/saturn-bgrt/

RUN update-alternatives --install /usr/share/plymouth/themes/default.plymouth default.plymouth /usr/share/plymouth/themes/saturn-bgrt/saturn-bgrt.plymouth 200  && \
    update-initramfs -u && \
    deluser --remove-home ubuntu


FROM scratch

ENTRYPOINT [ "/sbin/init" ]
CMD ["/bin/bash"]

COPY --from=interim-layer / /

RUN apt-get update -y && apt-get dist-upgrade -y && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install -y linux-headers-generic && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install -y linux-image-generic && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install -y grub-efi && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install -y plymouth plymouth-theme-spinner && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y snapd && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y flatpak && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log} && flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
RUN apt-get update -y && apt-get install --no-install-recommends -y packagekit && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y python3-gi && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y gir1.2-packagekitglib-1.0 && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y gir1.2-snapd-2 && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
RUN apt-get update -y && apt-get install --no-install-recommends -y gir1.2-flatpak-1.0 && rm -rf /var/lib/apt/lists/* /var/log/{alternatives.log,apt/history.log,apt/term.log,dpkg.log}
